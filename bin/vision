#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Vision CLI - Commandes utiles pour gérer le moteur de templates
 */

if (PHP_SAPI !== 'cli') {
    echo "Ce script doit être exécuté en ligne de commande.\n";
    exit(1);
}

// Autoloader
$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
];

foreach ($autoloadPaths as $path) {
    if (file_exists($path)) {
        require_once $path;
        break;
    }
}

use JulienLinard\Vision\Vision;
use JulienLinard\Vision\Parser\TemplateParser;
use JulienLinard\Vision\Compiler\TemplateCompiler;
use JulienLinard\Vision\Cache\CacheManager;
use JulienLinard\Vision\Cache\TaggedCacheManager;
use JulienLinard\Vision\Cache\WarmupManager;
use JulienLinard\Vision\Cache\FragmentCache;

$command = $argv[1] ?? 'help';

match ($command) {
    'help', '-h', '--help' => showHelp(),
    'cache:clear' => cacheClear($argv),
    'cache:stats' => cacheStats($argv),
    'fragment:clear' => fragmentClear($argv),
    'fragment:stats' => fragmentStats($argv),
    'compile' => compileTemplates($argv),
    'warmup' => warmupCache($argv),
    'version' => showVersion(),
    default => unknownCommand($command),
};

function showHelp(): void
{
    echo <<<'HELP'
Vision CLI - Moteur de templates PHP moderne

Usage:
  vision <commande> [options]

Commandes disponibles:
  help              Afficher cette aide
  version           Afficher la version de Vision
  cache:clear       Nettoyer le cache des templates
  cache:stats       Afficher les statistiques du cache
  fragment:clear    Nettoyer le cache des fragments (composants)
  fragment:stats    Afficher les statistiques du cache des fragments
  compile           Précompiler les templates (nécessite --templates et --cache)
  warmup            Préchauffer le cache des templates (nécessite --templates et --cache)

Exemples:
  vision cache:clear --cache=/path/to/cache
  vision cache:stats --cache=/path/to/compiled
  vision fragment:clear --cache=/path/to/fragments
  vision fragment:stats --cache=/path/to/fragments
  vision compile --templates=/path/to/templates --cache=/path/to/compiled [--tags=tag1,tag2]
  vision warmup --templates=/path/to/templates --cache=/path/to/compiled [--manifest=/path/to/manifest.json]

HELP;
}

function showVersion(): void
{
    echo "Vision Template Engine v2.0.0\n";
    echo "PHP " . PHP_VERSION . "\n";
}

function cacheClear(array $argv): void
{
    $cacheDir = getOption($argv, '--cache');

    if (!$cacheDir) {
        echo "Erreur: --cache requis\n";
        echo "Usage: vision cache:clear --cache=/path/to/cache\n";
        exit(1);
    }

    if (!is_dir($cacheDir)) {
        echo "Erreur: Le répertoire $cacheDir n'existe pas\n";
        exit(1);
    }

    $files = glob($cacheDir . '/*.cache');
    $phpFiles = glob($cacheDir . '/*.php');
    $allFiles = array_merge($files ?: [], $phpFiles ?: []);

    $deleted = 0;
    foreach ($allFiles as $file) {
        if (is_file($file)) {
            unlink($file);
            $deleted++;
        }
    }

    echo "✓ Cache nettoyé: $deleted fichier(s) supprimé(s)\n";
}

function cacheStats(array $argv): void
{
    $cacheDir = getOption($argv, '--cache');

    if (!$cacheDir) {
        echo "Erreur: --cache requis\n";
        echo "Usage: vision cache:stats --cache=/path/to/cache\n";
        exit(1);
    }

    if (!is_dir($cacheDir)) {
        echo "Erreur: Le répertoire $cacheDir n'existe pas\n";
        exit(1);
    }

    $cacheManager = new CacheManager($cacheDir, 3600);
    $stats = $cacheManager->getStats();

    echo "Statistiques du cache:\n";
    echo "  Répertoire: $cacheDir\n";
    echo "  Nombre de fichiers: {$stats['total']}\n";
    echo "  Taille totale: " . formatBytes($stats['size']) . "\n";

    if ($stats['oldest'] > 0) {
        $oldestDate = date('Y-m-d H:i:s', $stats['oldest']);
        echo "  Plus ancien: $oldestDate\n";
    }
}

function compileTemplates(array $argv): void
{
    $templatesDir = getOption($argv, '--templates');
    $cacheDir = getOption($argv, '--cache');
    $tagsOption = getOption($argv, '--tags');
    $useTags = $tagsOption !== null;

    if (!$templatesDir || !$cacheDir) {
        echo "Erreur: --templates et --cache requis\n";
        echo "Usage: vision compile --templates=/path/to/templates --cache=/path/to/compiled [--tags=tag1,tag2]\n";
        exit(1);
    }

    if (!is_dir($templatesDir)) {
        echo "Erreur: Le répertoire templates $templatesDir n'existe pas\n";
        exit(1);
    }

    if (!is_dir($cacheDir)) {
        mkdir($cacheDir, 0755, true);
    }

    $parser = new TemplateParser();
    $compiler = new TemplateCompiler();
    
    // Utiliser TaggedCacheManager si des tags sont fournis
    if ($useTags) {
        $cacheManager = new TaggedCacheManager($cacheDir, 86400);
        $tags = $tagsOption ? explode(',', $tagsOption) : [];
        $tags = array_map('trim', $tags);
        echo "Mode tags activé: " . implode(', ', $tags) . "\n";
    } else {
        $cacheManager = new CacheManager($cacheDir, 86400);
    }

    // Trouver tous les templates récursivement
    $templates = findTemplatesRecursive($templatesDir);

    $compiled = 0;
    $errors = 0;

    echo "Compilation des templates...\n";
    $startTime = microtime(true);
    
    foreach ($templates as $templatePath) {
        $content = file_get_contents($templatePath);
        if ($content === false) {
            $errors++;
            continue;
        }

        try {
            $parsed = $parser->parse($content);
            $compiledObj = $compiler->compile($parsed);
            
            if ($useTags && !empty($tags)) {
                $cacheManager->saveCompiled($templatePath, $compiledObj, $tags);
            } else {
                $cacheManager->saveCompiled($templatePath, $compiledObj);
            }
            
            $compiled++;
            $relativePath = str_replace($templatesDir . '/', '', $templatePath);
            echo "  ✓ $relativePath\n";
        } catch (Exception $e) {
            $errors++;
            $relativePath = str_replace($templatesDir . '/', '', $templatePath);
            echo "  ✗ $relativePath: {$e->getMessage()}\n";
        }
    }

    $duration = round(microtime(true) - $startTime, 2);
    echo "\n✓ Compilation terminée: $compiled template(s) compilé(s)";
    if ($errors > 0) {
        echo ", $errors erreur(s)";
    }
    echo " (en {$duration}s)\n";
}

function warmupCache(array $argv): void
{
    $templatesDir = getOption($argv, '--templates');
    $cacheDir = getOption($argv, '--cache');
    $manifestPath = getOption($argv, '--manifest');

    if (!$templatesDir || !$cacheDir) {
        if (!$manifestPath) {
            echo "Erreur: --templates et --cache requis, ou --manifest\n";
            echo "Usage: vision warmup --templates=/path/to/templates --cache=/path/to/compiled\n";
            echo "   ou: vision warmup --manifest=/path/to/manifest.json --cache=/path/to/compiled\n";
            exit(1);
        }
    }

    if (!is_dir($cacheDir)) {
        mkdir($cacheDir, 0755, true);
    }

    $vision = new Vision($templatesDir ?? '');
    $vision->setCache(true, $cacheDir, 86400);
    
    // Activer le pipeline compilé
    $parser = new TemplateParser();
    $compiler = new TemplateCompiler();
    $cacheManager = new CacheManager($cacheDir, 86400);
    $vision->setParser($parser);
    $vision->setCompiler($compiler);
    $vision->setCacheManager($cacheManager);

    $warmupManager = new WarmupManager();

    echo "Préchauffage du cache...\n";
    $startTime = microtime(true);

    if ($manifestPath) {
        try {
            $stats = $warmupManager->warmupFromManifest($manifestPath, $vision);
        } catch (Exception $e) {
            echo "Erreur: {$e->getMessage()}\n";
            exit(1);
        }
    } else {
        if (!is_dir($templatesDir)) {
            echo "Erreur: Le répertoire templates $templatesDir n'existe pas\n";
            exit(1);
        }
        $stats = $warmupManager->warmupDirectory($vision, $templatesDir, ['vis', 'html', 'php'], [], true);
    }

    $duration = round(microtime(true) - $startTime, 2);
    echo "\n✓ Préchauffage terminé: {$stats['warmed']} template(s) réchauffé(s)";
    if ($stats['errors'] > 0) {
        echo ", {$stats['errors']} erreur(s)";
    }
    echo " (en {$duration}s)\n";
}

function findTemplatesRecursive(string $directory): array
{
    $templates = [];
    $patterns = ['*.html.vis', '*.vis', '*.php', '*.html'];
    
    $iterator = new \RecursiveIteratorIterator(
        new \RecursiveDirectoryIterator($directory, \RecursiveDirectoryIterator::SKIP_DOTS),
        \RecursiveIteratorIterator::LEAVES_ONLY
    );

    foreach ($iterator as $file) {
        if (!$file->isFile()) {
            continue;
        }

        $extension = strtolower($file->getExtension());
        $filename = $file->getFilename();
        
        // Vérifier les patterns
        foreach ($patterns as $pattern) {
            $patternExt = str_replace('*.', '', $pattern);
            if ($extension === $patternExt || 
                ($patternExt === 'html.vis' && str_ends_with($filename, '.html.vis'))) {
                $templates[] = $file->getRealPath();
                break;
            }
        }
    }

    return array_unique($templates);
}

function fragmentClear(array $argv): void
{
    $cacheDir = getOption($argv, '--cache');

    if (!$cacheDir) {
        echo "Erreur: --cache requis\n";
        echo "Usage: vision fragment:clear --cache=/path/to/fragments\n";
        exit(1);
    }

    if (!is_dir($cacheDir)) {
        echo "Erreur: Le répertoire $cacheDir n'existe pas\n";
        exit(1);
    }

    $fragmentCache = new FragmentCache($cacheDir, 3600, true);
    $deleted = $fragmentCache->clearAll();

    echo "✓ Cache des fragments nettoyé: $deleted fragment(s) supprimé(s)\n";
}

function fragmentStats(array $argv): void
{
    $cacheDir = getOption($argv, '--cache');

    if (!$cacheDir) {
        echo "Erreur: --cache requis\n";
        echo "Usage: vision fragment:stats --cache=/path/to/fragments\n";
        exit(1);
    }

    if (!is_dir($cacheDir)) {
        echo "Erreur: Le répertoire $cacheDir n'existe pas\n";
        exit(1);
    }

    $fragmentCache = new FragmentCache($cacheDir, 3600, true);
    $stats = $fragmentCache->getStats();

    echo "Statistiques du cache des fragments:\n";
    echo "  Répertoire: $cacheDir\n";
    echo "  Nombre de fragments: {$stats['total']}\n";
    echo "  Taille totale: " . formatBytes($stats['size']) . "\n";

    if ($stats['oldest'] > 0) {
        $oldestDate = date('Y-m-d H:i:s', $stats['oldest']);
        echo "  Plus ancien: $oldestDate\n";
    }
}

function unknownCommand(string $command): void
{
    echo "Commande inconnue: $command\n";
    echo "Utilisez 'vision help' pour voir les commandes disponibles.\n";
    exit(1);
}

function getOption(array $argv, string $option): ?string
{
    foreach ($argv as $arg) {
        if (str_starts_with($arg, $option . '=')) {
            return substr($arg, strlen($option) + 1);
        }
    }
    return null;
}

function formatBytes(int $bytes): string
{
    $units = ['B', 'KB', 'MB', 'GB'];
    $unitIndex = 0;
    $value = $bytes;

    while ($value >= 1024 && $unitIndex < count($units) - 1) {
        $value /= 1024;
        $unitIndex++;
    }

    return round($value, 2) . ' ' . $units[$unitIndex];
}
